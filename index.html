<!--<!DOCTYPE html>-->
<html lang="kr">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title> Cloud Game</title>

    <style>
        :root {
            --color-text: #173e0b;
            --color-bg: #b2ca94;
            --color-cloud-bg-selectd: #dd61ab;
            --color-cloud-icon: #ffffff;
            --color-cloud-icon-selectd: #a4cafb;
            --color-board-border: #4286d4;
            --color-board-bg: #196dcd;
            --color-cloud-number: #0e1440;

            --duration: 50;
            --num-rows: 10;
            --num-cols: 16;
            --board-width: 700px;
            --board-height: calc( var(--board-width) * 0.6);
            --gap : 4px;
            --cloud-size: calc( var(--board-width) / var(--num-cols));
            --cloud-total-count: calc( 600 / var(--num-cols) * var(--num-rows));
            /* 그리드 셀 너비/높이 중 작은 쪽 기준 */
            --font-size: calc(
                    min(
                    ( (var(--board-width) - (var(--num-cols) - 1) * var(--gap)) / var(--num-cols) ),
                    ( (var(--board-height) - (var(--num-rows) - 1) * var(--gap)) / var(--num-rows) )
                    ) * 1
            );
            --padding : 10px;
        }

        @media (max-width: 768px) {
            :root {
                --num-rows: 5;
                --num-cols: 8;
                --board-width: 300px;
            }
        }

        * {
            margin: 0;
            padding: 0;
            font-family: monospace;
            color: var(--color-text);
        }

        body{
            padding-top: 15px;
            background-color: var(--color-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        i{
            font-size: var(--font-size);
            line-height: 1;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #board {
            position: relative;

            padding: var(--padding);
            border: 5px solid var(--color-board-border);
            border-radius: 12px;
            background-color: var(--color-board-bg);

            width: calc(var(--board-width) + var(--padding)*2 );
            height: calc(var(--board-height) + var(--padding)*2 );

            display: grid;
            grid-template-rows: repeat(var(--num-rows), 1fr);
            grid-template-columns: repeat(var(--num-cols), 1fr);
            gap: var(--gap);

            * {
                user-select: none;
            }

            .cloud{
                border-radius: calc(50%);
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;

                span {
                    position: absolute;
                    top: 30%;
                    left: 45%;

                    font-weight: bold;
                    font-size: calc(var(--font-size)/2.5);
                    color: var(--color-cloud-number);

                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1;
                }
            }

            .cloud.selected {
                background: var(--color-cloud-bg-selectd);
            }

            .cloud.collected {
                i {
                    opacity: 0;
                    transform: scale(1.5);
                    transition: opacity 300ms, transform 300ms;
                }
                span {
                    opacity: 0;
                }
            }

            #finalScore {
                width: 100%;
                height: 100%;
                font-size: 100px;

                display: flex;
                position: absolute;
                align-items: center;
                justify-content: center;

                -webkit-text-stroke: 1px white;
                text-shadow: 1px 1px 0 #a4cafb;
            }
        }

        #board:not(.playing) {
            .cloud {
                opacity: 0.5;
            }
            span {
                opacity: 0;
            }
            #finalScore {
                z-index: 2;
                opacity: 1;
                transform: scale(1);
                transition: opacity 300ms, transform 300ms;
            }
        }

        #board.playing {
            .cloud:not(.collected):hover {
                cursor: crosshair;
                background: var(--color-cloud-icon-selectd);

                span {
                    color: var(--color-cloud-bg-selectd);
                }
            }
            #finalScore {
                opacity: 0;
                transform: scale(0);
            }
        }

        #progress{
            flex-shrink: 1;

            width: 270px;
            height: 10px;
            border: honeydew 1px solid;
            background-image: linear-gradient(-225deg, #a1c4fd 0%, #c2e9fb 20%, #f6d365 40%, #fda085 55%, #fcb69f 70%, #09268a 100%);

            div {
                width: 100%;
                height: 100%;
                background-color: var(--color-bg);
            }

            div.playing {
                transform: scaleX(0);
                transform-origin: top right;
                transition: transform calc(var(--duration)*1s) linear;
            }
        }

        #start {
            position: relative;            /* span과 button의 기준 */
            display: inline-block;
            width: 400px;
            height: 200px;
            text-align: center;
            margin-top: 30px;
        }
        #start span {
            position: absolute;            /* 부모 기준 절대 위치 */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 400px;                /* 이모지 크기 */
            z-index: -1;                     /* 뒤로 보내기 */
        }
        #start button {
            position: relative;             /* 부모 기준, 이모지 위에 표시 */
            z-index: 1;
            background: none;               /* 배경 없음 */
            border: none;                   /* 테두리 없음 */
            font-size: 24px;
            cursor: pointer;
            color: #173e0b;                  /* 글자색 */
            font-weight:    bold;
            padding: 8px 16px;
        }

        #instruction {
            padding: var(--padding);
        }
        #instructionBtn {
            border: none;
            border-radius: 3px;
        }
    </style>
</head>
<body>
<!-- https://www.youtube.com/watch?v=QuoVDPM76wI 사과게임 만들기 참고 -->

    <h1> <i id="cloud-icon">☁️</i> Cloud Game <button id="instructionBtn" style="border: none">❓</button></h1>
    <div id="instruction" style="display: none;">
        <p>구름을 드래그해서 화면에서 제거하세요.</p>
        <ul>
            <li>START 버튼으로 게임을 시작합니다.</li>
            <li>다시하려면 RESTART 버튼을 클릭하세요.</li>
            <li>선택한 구름의 합이 10이 되면 없어집니다.</li>
            <li>타이머가 채워지는 2분 동안 최대한 많은 구름을 제거하세요.</li>
            <li>구름을 제거하면 점수가 올라갑니다.</li>
            <li>시간이 초과하거나 구름을 모두 제거하면 게임이 종료되고 점수가 공개됩니다.</li>
        </ul>
    </div>
    <div id="board">
        <h3 id="finalScore"></h3>
    </div>
    <div id="progress">
        <div></div>
    </div>
    <div id="scoreBoard">
        <div style="display: inline-block; margin: 0 20px">
            <h3>Count :
                <span id="collectedCount"> 0 </span> / <span id="totalCount"></span>
            </h3>
        </div>
        <div style="display: inline-block; margin: 0 20px">
            <h3>
                Score :
                <span id="score"> 0 </span>
            </h3>
        </div>
    </div>
    <div id="start">
        <span>☁️</span>
        <button id="startBtn"> Start </button>
        <div id="difficulty">
            <label>
                <input type="radio" name="mode" id="easy" value="false" checked> Easy
            </label>
            <label>
                <input type="radio" name="mode" id="hard" value="true"> Hard
            </label>
        </div>
    </div>

    <script>
        // constants
        const $root = document.querySelector(':root');
        const styles = window.getComputedStyle($root);
        const numRows = styles.getPropertyValue('--num-rows');
        const numCols = styles.getPropertyValue('--num-cols');
        const cloudSize = styles.getPropertyValue('--cloud-size');
        const duration = styles.getPropertyValue('--duration');
        const cloudTotalCount2 = styles.getPropertyValue('--cloud-total-count');
        const cloudTotalCount = numCols * numRows;
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

        // elements
        const $board = document.querySelector('#board');
        const $cloudIcon = document.querySelector('#cloud-icon');
        const $clouds = [];
        const $totalCount = document.querySelector('#totalCount');
        const $collectedCount = document.querySelector('#collectedCount');
        const $collectedScore = document.querySelector('#score');
        const $startBtn = document.querySelector('#startBtn');
        const $progressBar = document.querySelector('#progress > div');
        const $finalScore = document.querySelector('#finalScore');
        const $instruction = document.querySelector('#instruction');
        const $instructionBtn = document.querySelector('#instructionBtn');
        const $radiosHard = document.querySelector('#hard');

        // variables
        let playing = false;
        let dragging = false;
        let begin = null; //[row, col]
        let end = null; //[row, col]
        let score = 0;
        let count = 0;
        let timerId = null;

        console.debug("[DEBUG] initialize :", numRows, numCols, cloudSize);
        initialize();

        function initialize(){
            for(let row=0; row < numRows; row++){
                for(let col=0; col < numCols; col++){
                    const $cloud = document.createElement('div');
                    $cloud.className = 'cloud';

                    //feat : 클라우드 데이터 속성에 위치값 저장
                    $cloud.dataset.row = row.toString();
                    $cloud.dataset.col = col.toString();

                    //기존 svg 노드를 이동시키지 않고 새로운 독립적인 노드를 복제해 냄
                    // const $icon = document.importNode($appleIcon, true);
                    const $icon = $cloudIcon.cloneNode(true);
                    $icon.removeAttribute('id');

                    const $number = document.createElement('span');

                    if(isTouchDevice){
                        //터치 이벤트 등록
                        $cloud.addEventListener(
                            'touchstart', ()=> {
                                dragBegin(row,col);
                            }
                        );
                    }else{
                        //마우스 이벤트 등록
                        $cloud.addEventListener(
                            'mousedown',()=>{ dragBegin(row, col); }
                        );
                        $cloud.addEventListener(
                            'mousemove',()=>{ dragMove(row, col); }
                        );
                        $cloud.addEventListener(
                            'mouseup',()=>{ dragEnd(); }
                        );
                    }

                    $cloud.appendChild($icon);
                    $cloud.appendChild($number);
                    $board.appendChild($cloud);
                    $clouds.push($cloud);
                }
            }
            $totalCount.textContent = cloudTotalCount.toString();

            $startBtn.addEventListener(
                'click', ()=> { gameStart() } //restart
                // 'click', ()=> { playing? gameEnd() : gameStart() } //end + start
            );
            $instructionBtn.addEventListener(
                'click', ()=>{
                    if ($instruction.style.display === 'none') {
                        $instruction.style.display = 'block';
                        $instructionBtn.textContent = '?';
                    } else {
                        $instruction.style.display = 'none';
                        $instructionBtn.textContent = '❓';
                    }
                }
            )

            $cloudIcon.remove();

            if(isTouchDevice){
                //IOS 는 보드단위로 드래그를 추적
                $board.addEventListener(
                    'touchmove', (e)=> {
                        e.preventDefault(); // 스크롤 방지

                        const touch = e.touches[0];
                        const allElements = document.elementsFromPoint(touch.clientX, touch.clientY);
                        const clouds = allElements.filter(el => el.classList.contains('cloud'));
                        const cloudEl = clouds[0];

                        if(cloudEl){
                            const row = parseInt(cloudEl.dataset.row);
                            const col = parseInt(cloudEl.dataset.col);
                            dragMove(row, col);
                        }
                    },
                    { passive: false }
                );
                // 보드 영역 바깥에서도 dragEnd 가능하도록 document에 등록
                document.addEventListener('touchend', () => {
                    if (dragging) dragEnd();
                });
                // 시스템/브라우저가 터치를 강제로 취소할 때 발생
                document.addEventListener('touchcancel', () => {
                    if (dragging) dragEnd();
                });
            }else {
                //보드 영역을 벗어나면 클릭업처리로 선택을 끝냄.
                $board.addEventListener('mouseleave', ()=>{ dragEnd() });
            }

            console.debug("[DEBUG] initialize done");
        }

        //숫자배열 생성
        function generateNumbersMultipleOf10(size, hardMode = false) {
            // 가중치에 따른 1~9 랜덤 숫자 생성
            const weightedNumbers = [1,1,1,1,2,2,2,2,3,3,3,4,5,5,6,6,7,7,8,9];
            let numbers = [];

            if(hardMode){
                numbers = Array.from({ length: size }, () => weightedNumbers[Math.floor(Math.random() * weightedNumbers.length)]);
            }else{
                // 최대 크기별 반복 후 셔플 (예: 2배 또는 8배)
                const multiplier = size / weightedNumbers.length;
                for (let i = 0; i < multiplier; i++) {
                    numbers.push(...weightedNumbers);
                }
                for (let i = numbers.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [numbers[i], numbers[j]] = [numbers[j], numbers[i]];
                }
            }


            // 합계 계산
            let sum = numbers.reduce((a, b) => a + b, 0);
            let remainder = sum % 10;

            // 합계가 10의 배수가 아니면 하나의 숫자 수정
            if (remainder !== 0) {
                for (let i = 0; i < numbers.length; i++) {
                    let newVal = numbers[i] - remainder;
                    if (newVal >= 1) { // 1 이상 유지
                        numbers[i] = newVal;
                        break;
                    }
                    newVal = numbers[i] + (10 - remainder);
                    if (newVal <= 9) { // 9 이하 유지
                        numbers[i] = newVal;
                        break;
                    }
                }
            }

            return numbers;
        }

        //게임 시작
        function gameStart(){
            playing = true;
            score = 0;
            count = 0;
            $collectedCount.innerHTML = "0";
            $collectedScore.innerHTML = "0";
            $startBtn.innerHTML = "Reset";

            // 보드 초기화
            for(const $cloud of $board.querySelectorAll('.collected')){
                $cloud.classList.remove('collected');
            }

            //숫자 할당
            const mode = $radiosHard.checked;
            const randomNumber = generateNumbersMultipleOf10(cloudTotalCount, mode);
            for(const $cloud of $clouds){
                $cloud.querySelector('span').textContent = randomNumber.pop().toString();
            }

            //타이머 재시작
            $board.classList.add('playing');
            $progressBar.classList.remove('playing');
            $progressBar.offsetHeight;
            $progressBar.classList.add('playing');

            //타이머 종료시 게임종료
            if(timerId){
                clearTimeout(timerId);
            }
            timerId = setTimeout(gameEnd, duration * 1000);
            console.log("Cloud Game Start !", mode? "Hard Mode" : "Easy Mode");
        }

        //게임 종료
        function gameEnd(){
            beep(true, true, true);
            dragEnd(); //우선 호출 필수
            playing = false;

            $startBtn.innerHTML = "Start";
            $board.classList.remove('playing');
            $progressBar.classList.remove('playing');
            $finalScore.innerHTML = score;

            if(timerId){
                clearTimeout(timerId);
            }
            console.log("Cloud Game End !");
        }

        //드래그 시작 - 클릭
        function dragBegin(row, col){
            if (!playing){ return; }
            dragging = true;
            begin = [row, col];
            end = [row, col];
            clearSelection();
            console.debug("[DEBUG] dragBegin");
        }
        //드래그 이동 - 무브
        function dragMove(row, col){
            if (!playing || !dragging){ return; }
            end = [row, col];

            drawSelection();
            console.debug("[DEBUG] dragMove");
        }
        //드래그 마침 - 업
        function dragEnd(){
            if (!playing){ return; }
            collect();
            dragging = false;
            clearSelection();
            console.debug("[DEBUG] dragEnd");
        }

        //선택값 가져오기 & 점수 계산하기
        function collect(){
            let sum = 0;
            const $selectedClouds = $board.querySelectorAll('.cloud.selected:not(.collected)');

            for( const $cloud of $selectedClouds){
                sum += Number($cloud.querySelector('span').textContent);
                console.debug('[DEBUG] sum' , sum);
            }

            if(sum !== 10){ return;}

            beep(false, false, false);

            for( const $cloud of $selectedClouds){
                $cloud.classList.add('collected');
            }

            //점수계산
            const $count = $selectedClouds.length;
            count += $count;
            $collectedCount.innerHTML = count.toString();
            score += sum;
            $collectedScore.innerHTML = score.toString();
            console.log(`collected ${$count} element`);

            //게임종료 확인
            if(count>=cloudTotalCount){
                gameEnd();
            }
        }

        //선택란 지우기
        function clearSelection(){
            for(const $cloud of $board.querySelectorAll('.cloud.selected')){
                $cloud.classList.remove('selected');
            }
        }

        //선택란 그리기
        function drawSelection(){
            let minRow = Math.min(begin[0], end[0]);
            let maxRow = Math.max(begin[0], end[0]);
            let minCol = Math.min(begin[1], end[1]);
            let maxCol = Math.max(begin[1], end[1]);
            for(let row = minRow; row <= maxRow; row++){
                for(let col = minCol; col <= maxCol; col++){
                    const $cloud = $clouds[row  * numCols + col ];
                    $cloud.classList.add('selected');
                }
            }
        }

        function beep(long=false, high=false, up=false){
            console.debug("[DEBUG] 사운드");
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gainNode = ctx.createGain();
            const vibrato = ctx.createOscillator();
            const vibratoGain = ctx.createGain();

            if (ctx.state === "suspended") {
                ctx.resume();
            }

            const duration = long ? 2 : 0.5;
            const baseFreq = high ? 300 : 200;
            const volume = up ? 0.2 : 0.1;

            osc.type = "triangle";
            osc.frequency.value = baseFreq;
            gainNode.gain.setValueAtTime(volume, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration); // n초 동안 줄어듦
            vibrato.frequency.value = 5;
            vibratoGain.gain.value = 20; // ±20Hz 정도 흔들리게

            vibrato.connect(vibratoGain);
            vibratoGain.connect(osc.frequency);
            osc.connect(gainNode);
            gainNode.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + duration);
        }
    </script>
</body>
</html>
